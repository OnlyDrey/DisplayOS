#!/usr/bin/env bash

set -euo pipefail

echo -e "${BLUE}[+] Dumping effective configuration...${NOCOLOR}"

mkdir -p "${OUTPUT_DIR}"

{
  echo "# DisplayOS Build Configuration"
  echo "# Generated: $(date -Iseconds)"
  echo ""
  echo "## User / Authentication"
  echo "SET_USERNAME=${SET_USERNAME}"
  echo "SET_PASSWORD=${SET_PASSWORD}"
  echo "GENERATE_PASSWORD=${GENERATE_PASSWORD}"
  echo ""
  echo "## Kiosk Settings"
  echo "KIOSK_URL=${KIOSK_URL}"
  echo "DEFAULT_BROWSER=${DEFAULT_BROWSER}"
  echo "KIOSK_AUTORESTART=${KIOSK_AUTORESTART}"
  echo ""
  echo "## Identity / Branding"
  echo "PRODUCT_NAME=${PRODUCT_NAME}"
  echo "SET_HOSTNAME=${SET_HOSTNAME}"
  echo "DISTRO=${DISTRO}"
  echo "ARCH=${ARCH}"
  echo "ISO_LABEL=${ISO_LABEL}"
  echo ""
  echo "## Installer UI Branding"
  echo "INSTALLER_PRIMARY_COLOR=${INSTALLER_PRIMARY_COLOR}"
  echo "INSTALLER_SECONDARY_COLOR=${INSTALLER_SECONDARY_COLOR}"
  echo "INSTALLER_TEXT_COLOR=${INSTALLER_TEXT_COLOR}"
  echo "INSTALLER_BG_COLOR=${INSTALLER_BG_COLOR}"
  echo ""
  echo "## Locale / Time / Keyboard"
  echo "TIMEZONE=${TIMEZONE}"
  echo "LOCALE=${LOCALE}"
  echo "KEYMAP=${KEYMAP}"
  echo "KEYMAP_MODEL=${KEYMAP_MODEL}"
  echo "KEYMAP_VARIANT=${KEYMAP_VARIANT}"
  echo ""
  echo "## SSH & Security"
  echo "ENABLE_SSH=${ENABLE_SSH}"
  echo ""
  echo "## Disk Handling"
  echo "PARTITION_RECIPE=${PARTITION_RECIPE}"
  echo "ERASE_ALL_DATA_TOKEN=${ERASE_ALL_DATA_TOKEN}"
  echo ""
  echo "## Asset Files"
  echo "WALLPAPER_IMG=${WALLPAPER_IMG}"
  echo "SPLASH_IMG=${SPLASH_IMG}"
  echo "INSTALLER_IMG=${INSTALLER_IMG}"
  echo ""
  echo "## live-build Settings"
  echo "BINARY_IMAGES=${BINARY_IMAGES}"
  echo "ARCHIVE_AREAS=${ARCHIVE_AREAS}"
  echo "DEBIAN_INSTALLER=${DEBIAN_INSTALLER}"
  echo "DEBIAN_INSTALLER_GUI=${DEBIAN_INSTALLER_GUI}"
  echo "APT_RECOMMENDS=${APT_RECOMMENDS}"
  echo ""
  echo "## Debug"
  echo "DEBUG=${DEBUG}"
  echo ""
  echo "## Package Count"
  echo "PACKAGES_COUNT=${#PACKAGES[@]}"
  echo ""
  echo "## Paths"
  echo "ROOT_DIR=${ROOT_DIR}"
  echo "OUTPUT_DIR=${OUTPUT_DIR}"
  echo "ASSETS_DIR=${ASSETS_DIR}"
  echo "CONFIG_DIR=${CONFIG_DIR}"
  echo "SCRIPTS_DIR=${SCRIPTS_DIR}"
} > "${CONFIG_OUT}"

echo ""
echo "[âœ“] Configuration saved to: ${CONFIG_OUT}"
